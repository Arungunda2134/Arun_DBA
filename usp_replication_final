-- Standalone script (fixed): Check replication Log Reader and Distribution agent status + recent SQL Agent job outcomes
-- No parameters. Run on the Distributor (or a server that can enumerate replication agents).
-- Requires: Ad Hoc Distributed Queries enabled (OPENROWSET) and permissions to read msdb job history.

SET NOCOUNT ON;

-- Cleanup previous run
IF OBJECT_ID('tempdb..#LogReader') IS NOT NULL DROP TABLE #LogReader;
IF OBJECT_ID('tempdb..#Distributor') IS NOT NULL DROP TABLE #Distributor;
IF OBJECT_ID('tempdb..#AllAgents') IS NOT NULL DROP TABLE #AllAgents;
IF OBJECT_ID('tempdb..#AgentWithJob') IS NOT NULL DROP TABLE #AgentWithJob;

-- Temp table schemas (match sp_MSenum_replication_agents result sets)
CREATE TABLE #LogReader (
    DBNAME SYSNAME NULL,
    NAME SYSNAME NULL,
    STATUS INT NULL,
    PUBLISHER SYSNAME NULL,
    PUBLISHER_DB SYSNAME NULL,
    START_TIME DATETIME NULL,
    TIME DATETIME NULL,
    DURATION INT NULL,
    COMMENTS NVARCHAR(1000) NULL,
    DELIVERY_TIME INT NULL,
    DELIVERED_TRANSACTIONS INT NULL,
    DELIVERED_COMMANDS INT NULL,
    AVERAGE_COMMANDS INT NULL,
    DELIVERY_RATE INT NULL,
    DELIVERY_LATENCY INT NULL,
    ERROR_ID INT NULL,
    JOB_ID BINARY(16) NULL,
    LOCAL_JOB INT NULL,
    PROFILE_ID INT NULL,
    AGENT_ID INT NULL,
    LOCAL_TIMESTAMP BINARY(8) NULL
);

CREATE TABLE #Distributor (
    DBNAME SYSNAME NULL,
    NAME SYSNAME NULL,
    STATUS INT NULL,
    PUBLISHER SYSNAME NULL,
    PUBLISHER_DB SYSNAME NULL,
    PUBLICATION SYSNAME NULL,
    SUBSCRIBER SYSNAME NULL,
    SUBSCRIBER_DB SYSNAME NULL,
    SUBSCRIPTION_TYPE INT NULL,
    START_TIME DATETIME NULL,
    TIME DATETIME NULL,
    DURATION INT NULL,
    COMMENTS NVARCHAR(1000) NULL,
    DELIVERY_TIME INT NULL,
    DELIVERED_TRANSACTIONS INT NULL,
    DELIVERED_COMMANDS INT NULL,
    AVERAGE_COMMANDS INT NULL,
    DELIVERY_RATE INT NULL,
    DELIVERY_LATENCY INT NULL,
    ERROR_ID INT NULL,
    JOB_ID BINARY(16) NULL,
    LOCAL_JOB INT NULL,
    PROFILE_ID INT NULL,
    AGENT_ID INT NULL,
    LOCAL_TIMESTAMP BINARY(8) NULL,
    OFFLOAD_ENABLED BIT NULL,
    OFFLOAD_SERVER VARCHAR(50) NULL,
    SUBSCRIBER_TYPE INT NULL
);

-- Use OPENROWSET to enumerate agents (avoids nested INSERT...EXEC)
INSERT INTO #LogReader
SELECT * FROM OPENROWSET(
  'SQLOLEDB',
  'Server=(local);Trusted_Connection=Yes;',
  'SET FMTONLY OFF EXEC sp_MSenum_replication_agents @type = 2 WITH RESULT SETS
  (
    (
      DBNAME SYSNAME NULL,
      NAME SYSNAME NULL,
      STATUS INT NULL,
      PUBLISHER SYSNAME NULL,
      PUBLISHER_DB SYSNAME NULL,
      START_TIME DATETIME NULL,
      TIME DATETIME NULL,
      DURATION INT NULL,
      COMMENTS NVARCHAR(1000),
      DELIVERY_TIME INT NULL,
      DELIVERED_TRANSACTIONS INT NULL,
      DELIVERED_COMMANDS INT NULL,
      AVERAGE_COMMANDS INT NULL,
      DELIVERY_RATE INT NULL,
      DELIVERY_LATENCY INT NULL,
      ERROR_ID INT NULL,
      JOB_ID BINARY(16) NULL,
      LOCAL_JOB INT NULL,
      PROFILE_ID INT NULL,
      AGENT_ID INT NULL,
      LOCAL_TIMESTAMP BINARY(8) NULL
    )
  )'
);

INSERT INTO #Distributor
SELECT * FROM OPENROWSET(
  'SQLOLEDB',
  'Server=(local);Trusted_Connection=Yes;',
  'SET FMTONLY OFF EXEC sp_MSenum_replication_agents @type = 3 WITH RESULT SETS
  (
    (
      DBNAME SYSNAME NULL,
      NAME SYSNAME NULL,
      STATUS INT NULL,
      PUBLISHER SYSNAME NULL,
      PUBLISHER_DB SYSNAME NULL,
      PUBLICATION SYSNAME NULL,
      SUBSCRIBER SYSNAME NULL,
      SUBSCRIBER_DB SYSNAME NULL,
      SUBSCRIPTION_TYPE INT NULL,
      START_TIME DATETIME NULL,
      TIME DATETIME NULL,
      DURATION INT NULL,
      COMMENTS NVARCHAR(1000),
      DELIVERY_TIME INT NULL,
      DELIVERED_TRANSACTIONS INT NULL,
      DELIVERED_COMMANDS INT NULL,
      AVERAGE_COMMANDS INT NULL,
      DELIVERY_RATE INT NULL,
      DELIVERY_LATENCY INT NULL,
      ERROR_ID INT NULL,
      JOB_ID BINARY(16) NULL,
      LOCAL_JOB INT NULL,
      PROFILE_ID INT NULL,
      AGENT_ID INT NULL,
      LOCAL_TIMESTAMP BINARY(8) NULL,
      OFFLOAD_ENABLED BIT NULL,
      OFFLOAD_SERVER VARCHAR(50) NULL,
      SUBSCRIBER_TYPE INT NULL
    )
  )'
);

-- Consolidate into one agents table (explicitly allow NULLs for PUBLICATION etc.)
CREATE TABLE #AllAgents (
    AgentType NVARCHAR(20) NULL,
    DBNAME SYSNAME NULL,
    NAME SYSNAME NULL,
    STATUS INT NULL,
    PUBLISHER SYSNAME NULL,
    PUBLISHER_DB SYSNAME NULL,
    PUBLICATION SYSNAME NULL,
    SUBSCRIBER SYSNAME NULL,
    SUBSCRIBER_DB SYSNAME NULL,
    SUBSCRIPTION_TYPE INT NULL,
    START_TIME DATETIME NULL,
    TIME DATETIME NULL,
    DURATION INT NULL,
    COMMENTS NVARCHAR(1000) NULL,
    DELIVERY_TIME INT NULL,
    DELIVERED_TRANSACTIONS INT NULL,
    DELIVERED_COMMANDS INT NULL,
    AVERAGE_COMMANDS INT NULL,
    DELIVERY_RATE INT NULL,
    DELIVERY_LATENCY INT NULL,
    ERROR_ID INT NULL,
    JOB_ID BINARY(16) NULL,
    LOCAL_JOB INT NULL,
    PROFILE_ID INT NULL,
    AGENT_ID INT NULL,
    LOCAL_TIMESTAMP BINARY(8) NULL,
    OFFLOAD_ENABLED BIT NULL,
    OFFLOAD_SERVER VARCHAR(50) NULL,
    SUBSCRIBER_TYPE INT NULL
);

-- When inserting LogReader rows, explicitly supply typed NULLs for columns that don't exist in #LogReader (PUBLICATION, SUBSCRIBER, SUBSCRIBER_DB, SUBSCRIPTION_TYPE, OFFLOAD_*)
INSERT INTO #AllAgents (
    AgentType, DBNAME, NAME, STATUS, PUBLISHER, PUBLISHER_DB, PUBLICATION, SUBSCRIBER, SUBSCRIBER_DB, SUBSCRIPTION_TYPE,
    START_TIME, TIME, DURATION, COMMENTS, DELIVERY_TIME, DELIVERED_TRANSACTIONS, DELIVERED_COMMANDS, AVERAGE_COMMANDS,
    DELIVERY_RATE, DELIVERY_LATENCY, ERROR_ID, JOB_ID, LOCAL_JOB, PROFILE_ID, AGENT_ID, LOCAL_TIMESTAMP, OFFLOAD_ENABLED, OFFLOAD_SERVER, SUBSCRIBER_TYPE
)
SELECT
    'LogReader' AS AgentType,
    DBNAME,
    NAME,
    STATUS,
    PUBLISHER,
    PUBLISHER_DB,
    CAST(NULL AS SYSNAME) AS PUBLICATION,
    CAST(NULL AS SYSNAME) AS SUBSCRIBER,
    CAST(NULL AS SYSNAME) AS SUBSCRIBER_DB,
    CAST(NULL AS INT) AS SUBSCRIPTION_TYPE,
    START_TIME,
    TIME,
    DURATION,
    COMMENTS,
    DELIVERY_TIME,
    DELIVERED_TRANSACTIONS,
    DELIVERED_COMMANDS,
    AVERAGE_COMMANDS,
    DELIVERY_RATE,
    DELIVERY_LATENCY,
    ERROR_ID,
    JOB_ID,
    LOCAL_JOB,
    PROFILE_ID,
    AGENT_ID,
    LOCAL_TIMESTAMP,
    CAST(NULL AS BIT) AS OFFLOAD_ENABLED,
    CAST(NULL AS VARCHAR(50)) AS OFFLOAD_SERVER,
    CAST(NULL AS INT) AS SUBSCRIBER_TYPE
FROM #LogReader;

-- Insert Distributor rows (they supply PUBLICATION etc.)
INSERT INTO #AllAgents (
    AgentType, DBNAME, NAME, STATUS, PUBLISHER, PUBLISHER_DB, PUBLICATION, SUBSCRIBER, SUBSCRIBER_DB, SUBSCRIPTION_TYPE,
    START_TIME, TIME, DURATION, COMMENTS, DELIVERY_TIME, DELIVERED_TRANSACTIONS, DELIVERED_COMMANDS, AVERAGE_COMMANDS,
    DELIVERY_RATE, DELIVERY_LATENCY, ERROR_ID, JOB_ID, LOCAL_JOB, PROFILE_ID, AGENT_ID, LOCAL_TIMESTAMP, OFFLOAD_ENABLED, OFFLOAD_SERVER, SUBSCRIBER_TYPE
)
SELECT
    'Distributor' AS AgentType,
    DBNAME,
    NAME,
    STATUS,
    PUBLISHER,
    PUBLISHER_DB,
    PUBLICATION,
    SUBSCRIBER,
    SUBSCRIBER_DB,
    SUBSCRIPTION_TYPE,
    START_TIME,
    TIME,
    DURATION,
    COMMENTS,
    DELIVERY_TIME,
    DELIVERED_TRANSACTIONS,
    DELIVERED_COMMANDS,
    AVERAGE_COMMANDS,
    DELIVERY_RATE,
    DELIVERY_LATENCY,
    ERROR_ID,
    JOB_ID,
    LOCAL_JOB,
    PROFILE_ID,
    AGENT_ID,
    LOCAL_TIMESTAMP,
    OFFLOAD_ENABLED,
    OFFLOAD_SERVER,
    SUBSCRIBER_TYPE
FROM #Distributor;

-- Build a reusable temp table with job join and mapped statuses
CREATE TABLE #AgentWithJob (
    AgentType NVARCHAR(20) NULL,
    DBNAME SYSNAME NULL,
    AgentName SYSNAME NULL,
    AgentStatusCode INT NULL,
    AgentStatusText NVARCHAR(50) NULL,
    Publisher SYSNAME NULL,
    Publisher_DB SYSNAME NULL,
    Publication SYSNAME NULL,
    Subscriber SYSNAME NULL,
    Subscriber_DB SYSNAME NULL,
    Delivered_Transactions INT NULL,
    Delivery_Latency INT NULL,
    Error_ID INT NULL,
    AgentComments NVARCHAR(1000) NULL,
    JOB_ID BINARY(16) NULL,
    JobName SYSNAME NULL,
    JobEnabled BIT NULL,
    JobRunStatusCode INT NULL,
    JobRunStatusText NVARCHAR(50) NULL,
    JobLastRunTime DATETIME NULL,
    JobLastMessage NVARCHAR(4000) NULL,
    JobIdHex VARCHAR(100) NULL
);

INSERT INTO #AgentWithJob
SELECT
    A.AgentType,
    A.DBNAME,
    A.NAME AS AgentName,
    A.STATUS AS AgentStatusCode,
    CASE A.STATUS WHEN 1 THEN 'Started' WHEN 2 THEN 'Stopped' WHEN 3 THEN 'In Progress' WHEN 4 THEN 'Idle' WHEN 5 THEN 'Retrying' WHEN 6 THEN 'Failed' ELSE 'Unknown' END AS AgentStatusText,
    A.PUBLISHER,
    A.PUBLISHER_DB,
    A.PUBLICATION,
    A.SUBSCRIBER,
    A.SUBSCRIBER_DB,
    A.DELIVERED_TRANSACTIONS,
    A.DELIVERY_LATENCY,
    A.ERROR_ID,
    A.COMMENTS AS AgentComments,
    A.JOB_ID,
    SJ.name AS JobName,
    SJ.enabled AS JobEnabled,
    H.run_status AS JobRunStatusCode,
    CASE H.run_status WHEN 0 THEN 'Failed' WHEN 1 THEN 'Succeeded' WHEN 2 THEN 'Retry' WHEN 3 THEN 'Canceled' WHEN 4 THEN 'In Progress' ELSE 'Unknown' END AS JobRunStatusText,
    msdb.dbo.agent_datetime(H.run_date, H.run_time) AS JobLastRunTime,
    H.message AS JobLastMessage,
    CONVERT(VARCHAR(100), sys.fn_varbintohexstr(A.JOB_ID)) AS JobIdHex
FROM #AllAgents A
LEFT JOIN msdb.dbo.sysjobs SJ
    ON SJ.job_id = A.JOB_ID
OUTER APPLY (
    SELECT TOP (1) h.run_date, h.run_time, h.run_status, h.message
    FROM msdb.dbo.sysjobhistory h
    WHERE h.job_id = SJ.job_id AND h.step_id = 0
    ORDER BY h.run_date DESC, h.run_time DESC, h.instance_id DESC
) H;

-- Resultset 1: All agents with status and last job run details
SELECT
    AgentType,
    DBNAME,
    AgentName,
    AgentStatusCode,
    AgentStatusText,
    JobName,
    JobIdHex,
    JobEnabled,
    JobRunStatusCode,
    JobRunStatusText,
    JobLastRunTime,
    JobLastMessage,
    Delivered_Transactions,
    Delivery_Latency,
    Error_ID,
    AgentComments
FROM #AgentWithJob
ORDER BY AgentType, DBNAME, AgentName;

-- Resultset 2: Problems only (filters)
SELECT
    AgentType,
    DBNAME,
    AgentName,
    AgentStatusText,
    JobName,
    JobRunStatusText,
    JobLastRunTime,
    JobLastMessage,
    Delivered_Transactions,
    Delivery_Latency,
    Error_ID,
    AgentComments
FROM #AgentWithJob
WHERE
    AgentStatusCode IN (5,6) -- Retrying or Failed
    OR JobRunStatusCode IN (0,2) -- Failed or Retry
    OR Error_ID IS NOT NULL
    OR (Delivery_Latency IS NOT NULL AND Delivery_Latency > 120) -- threshold
ORDER BY AgentType, DBNAME, AgentName;

-- Optional cleanup
IF OBJECT_ID('tempdb..#LogReader') IS NOT NULL DROP TABLE #LogReader;
IF OBJECT_ID('tempdb..#Distributor') IS NOT NULL DROP TABLE #Distributor;
IF OBJECT_ID('tempdb..#AllAgents') IS NOT NULL DROP TABLE #AllAgents;
IF OBJECT_ID('tempdb..#AgentWithJob') IS NOT NULL DROP TABLE #AgentWithJob;

PRINT 'Done - review the "All agents" and "Problems only" resultsets.';
