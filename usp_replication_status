
DECLARE @Sqltext NVARCHAR(MAX)


DECLARE @Publisher SYSNAME, @PublisherDB SYSNAME, @Publication SYSNAME, @Distdb SYSNAME, 
@Subscriber SYSNAME, @SubscriberDB SYSNAME

IF OBJECT_ID('tempdb..#REPLMONITORPUBLISHER') IS NOT NULL 
DROP TABLE #REPLMONITORPUBLISHER 

CREATE TABLE #REPLMONITORPUBLISHER
(
SN INT IDENTITY(1,1)
,PUBLISHER SYSNAME NULL
,DISTRIBUTION_DB SYSNAME NULL
,STATUS INT NULL
,WARNING INT NULL
,PUBLICATIONCOUNT INT NULL
,RETURNSTAMP VARCHAR(100) NULL
)
insert into #REPLMONITORPUBLISHER
SELECT * FROM OPENROWSET('SQLOLEDB', 'SERVER=(LOCAL);TRUSTED_CONNECTION=YES;'
, 'SET FMTONLY OFF EXEC distribution.dbo.sp_replmonitorhelppublisher WITH RESULT SETS
(
  (
    PUBLISHER SYSNAME NULL
,DISTRIBUTION_DB SYSNAME NULL
,STATUS INT NULL
,WARNING INT NULL
,PUBLICATIONCOUNT INT NULL
,RETURNSTAMP VARCHAR(100) NULL
  )
)')

IF OBJECT_ID('tempdb..#REPLMONITORSUBSCRIPTION') IS NOT NULL 
DROP TABLE #REPLMONITORSUBSCRIPTION 

CREATE TABLE #REPLMONITORSUBSCRIPTION
(
SN INT IDENTITY(1,1)
,PUBLISHER SYSNAME NULL
,DISTRIBUTION_DB SYSNAME NULL
,STATUS INT NULL
,WARNING INT NULL
,SUBSCRIBER SYSNAME NULL
,SUBSCRIBER_DB SYSNAME NULL
,PUBLISHER_DB SYSNAME NULL
,PUBLICATION SYSNAME NULL
,PUBLICATION_TYPE INT NULL
,SUBTYPE INT NULL
,LATENCY INT NULL
,LATENCYTHRESHOLD FLOAT NULL
,AGENTNOTRUNNING INT NULL
,AGENTNOTRUNNINGTHRESHOLD INT NULL
,TIMETOEXPIRATION INT NULL
,EXPIRATIONTHRESHOLD INT NULL
,LAST_DISTSYNC DATETIME NULL
,DISTRIBUTION_AGENTNAME SYSNAME NULL
,MONITORRANKING INT NULL
,DISTRIBUTIONAGENTJOBID BINARY(16) NULL
,DISTRIBUTIONAGENTID INT NULL
,DISTRIBUTIONAGENTPROFILEID INT NULL
,LOGREADERAGENTNAME SYSNAME NULL
)

IF OBJECT_ID('tempdb..#REPLLOGREADERAGENT') IS NOT NULL 
DROP TABLE #REPLLOGREADERAGENT 

CREATE TABLE #REPLLOGREADERAGENT
(
SN INT IDENTITY(1,1)
,DBNAME SYSNAME NULL
,NAME SYSNAME NULL
,STATUS INT NULL
,PUBLISHER SYSNAME NULL
,PUBLISHER_DB SYSNAME NULL
,START_TIME DATETIME NULL
,TIME DATETIME NULL
,DURATION INT NULL
,COMMENTS NVARCHAR(1000)
,DELIVERY_TIME INT NULL
,DELIVERED_TRANSACTIONS INT NULL
,DELIVERED_COMMANDS INT NULL
,AVERAGE_COMMANDS INT NULL
,DELIVERY_RATE INT NULL
,DELIVERY_LATENCY INT NULL
,ERROR_ID INT NULL
,JOB_ID BINARY(16) NULL
,LOCAL_JOB INT NULL
,PROFILE_ID INT NULL
,AGENT_ID INT NULL
,LOCAL_TIMESTAMP BINARY(8) NULL
)
INSERT INTO #REPLLOGREADERAGENT
SELECT * FROM OPENROWSET ('SQLOLEDB','Server=(local);TRUSTED_CONNECTION=YES;',
'set fmtonly off EXEC sp_MSenum_replication_agents @type = 2 WITH RESULT SETS
(
  (
    DBNAME SYSNAME NULL
,NAME SYSNAME NULL
,STATUS INT NULL
,PUBLISHER SYSNAME NULL
,PUBLISHER_DB SYSNAME NULL
,START_TIME DATETIME NULL
,TIME DATETIME NULL
,DURATION INT NULL
,COMMENTS NVARCHAR(1000)
,DELIVERY_TIME INT NULL
,DELIVERED_TRANSACTIONS INT NULL
,DELIVERED_COMMANDS INT NULL
,AVERAGE_COMMANDS INT NULL
,DELIVERY_RATE INT NULL
,DELIVERY_LATENCY INT NULL
,ERROR_ID INT NULL
,JOB_ID BINARY(16) NULL
,LOCAL_JOB INT NULL
,PROFILE_ID INT NULL
,AGENT_ID INT NULL
,LOCAL_TIMESTAMP BINARY(8) NULL
  )
)') 
IF OBJECT_ID('tempdb..#REPLDISTRIBUTORAGENT') IS NOT NULL 
DROP TABLE #REPLDISTRIBUTORAGENT 

CREATE TABLE #REPLDISTRIBUTORAGENT
(
SN INT IDENTITY(1,1)
,DBNAME SYSNAME NULL
,NAME SYSNAME NULL
,STATUS INT NULL
,PUBLISHER SYSNAME NULL
,PUBLISHER_DB SYSNAME NULL
,PUBLICATION SYSNAME NULL
,SUBSCRIBER SYSNAME NULL
,SUBSCRIBER_DB SYSNAME NULL
,SUBSCRIPTION_TYPE INT NULL
,START_TIME DATETIME NULL
,TIME DATETIME NULL
,DURATION INT NULL
,COMMENTS NVARCHAR(1000)
,DELIVERY_TIME INT NULL
,DELIVERED_TRANSACTIONS INT NULL
,DELIVERED_COMMANDS INT NULL
,AVERAGE_COMMANDS INT NULL
,DELIVERY_RATE INT NULL
,DELIVERY_LATENCY INT NULL
,ERROR_ID INT NULL
,JOB_ID BINARY(16) NULL
,LOCAL_JOB INT NULL
,PROFILE_ID INT NULL
,AGENT_ID INT NULL
,LOCAL_TIMESTAMP BINARY(8) NULL
,OFFLOAD_ENABLED BIT NULL
,OFFLOAD_SERVER VARCHAR(50)
,SUBSCRIBER_TYPE INT NULL
)

 

DECLARE CURSORPUBLISHER CURSOR FOR
SELECT PUBLISHER, DISTRIBUTION_DB 
FROM #REPLMONITORPUBLISHER;

OPEN CURSORPUBLISHER

FETCH NEXT FROM CURSORPUBLISHER
INTO @Publisher, @Distdb

WHILE @@FETCH_STATUS = 0
BEGIN

SET @Sqltext = 'SELECT ''' + @Publisher + ''', ''' + @Distdb + ''', STATUS, WARNING, 
SUBSCRIBER, SUBSCRIBER_DB,PUBLISHER_DB, PUBLICATION , PUBLICATION_TYPE, SUBTYPE, 
LATENCY, LATENCYTHRESHOLD, AGENTNOTRUNNING, AGENTNOTRUNNINGTHRESHOLD, 
TIMETOEXPIRATION, EXPIRATIONTHRESHOLD, LAST_DISTSYNC, DISTRIBUTION_AGENTNAME, 
MONITORRANKING, DISTRIBUTIONAGENTJOBID, DISTRIBUTIONAGENTID, 
DISTRIBUTIONAGENTPROFILEID, LOGREADERAGENTNAME FROM 
OPENROWSET (''SQLOLEDB'',''Server=(local);TRUSTED_CONNECTION=YES;'', 
''set fmtonly off EXEC ' + @Distdb + '..sp_replmonitorhelpsubscription @publisher = '''''
+ @Publisher +''''', @publication_type = 0 WITH RESULT SETS
(
  (

STATUS INT NULL
,WARNING INT NULL
,SUBSCRIBER SYSNAME NULL
,SUBSCRIBER_DB SYSNAME NULL
,PUBLISHER_DB SYSNAME NULL
,PUBLICATION SYSNAME NULL
,PUBLICATION_TYPE INT NULL
,SUBTYPE INT NULL
,LATENCY INT NULL
,LATENCYTHRESHOLD FLOAT NULL
,AGENTNOTRUNNING INT NULL
,AGENTNOTRUNNINGTHRESHOLD INT NULL
,TIMETOEXPIRATION INT NULL
,EXPIRATIONTHRESHOLD INT NULL
,LAST_DISTSYNC DATETIME NULL
,DISTRIBUTION_AGENTNAME SYSNAME NULL
,mergeagentname SYSNAME NULL
,mergesubscriptionfriendlyname SYSNAME NULL
,mergeagentlocation SYSNAME NULL
,mergeconnectiontype SYSNAME NULL
,mergePerformance SYSNAME NULL
,mergerunspeed INT NULL
,mergerunduration INT NULL
,MONITORRANKING INT NULL
,DISTRIBUTIONAGENTJOBID BINARY(16) NULL
,mergeagentjobid INT NULL
,DISTRIBUTIONAGENTID INT NULL
,DISTRIBUTIONAGENTPROFILEID INT NULL
,mergeagentid INT NULL
,mergeagentprofileid INT NULL
,LOGREADERAGENTNAME SYSNAME NULL
,publisher SYSNAME NULL
)
)'') ' 
print @sqltext
INSERT INTO #REPLMONITORSUBSCRIPTION (PUBLISHER, DISTRIBUTION_DB, STATUS, WARNING, 
SUBSCRIBER, SUBSCRIBER_DB, PUBLISHER_DB, PUBLICATION ,PUBLICATION_TYPE, SUBTYPE, 
LATENCY, LATENCYTHRESHOLD, AGENTNOTRUNNING, AGENTNOTRUNNINGTHRESHOLD, 
TIMETOEXPIRATION, EXPIRATIONTHRESHOLD, LAST_DISTSYNC, DISTRIBUTION_AGENTNAME, 
MONITORRANKING, DISTRIBUTIONAGENTJOBID, DISTRIBUTIONAGENTID, DISTRIBUTIONAGENTPROFILEID,
LOGREADERAGENTNAME)
EXEC (@Sqltext)

FETCH NEXT FROM CURSORPUBLISHER
INTO @Publisher, @Distdb
END

CLOSE CURSORPUBLISHER;
DEALLOCATE CURSORPUBLISHER;




INSERT INTO #REPLDISTRIBUTORAGENT 
SELECT * FROM OPENROWSET ('SQLOLEDB','Server=(local);TRUSTED_CONNECTION=YES;', 
'set fmtonly off EXEC sp_MSenum_replication_agents @type = 3  WITH RESULT SETS
(
  (
    DBNAME SYSNAME NULL
,NAME SYSNAME NULL
,STATUS INT NULL
,PUBLISHER SYSNAME NULL
,PUBLISHER_DB SYSNAME NULL
,PUBLICATION SYSNAME NULL
,SUBSCRIBER SYSNAME NULL
,SUBSCRIBER_DB SYSNAME NULL
,SUBSCRIPTION_TYPE INT NULL
,START_TIME DATETIME NULL
,TIME DATETIME NULL
,DURATION INT NULL
,COMMENTS NVARCHAR(1000)
,DELIVERY_TIME INT NULL
,DELIVERED_TRANSACTIONS INT NULL
,DELIVERED_COMMANDS INT NULL
,AVERAGE_COMMANDS INT NULL
,DELIVERY_RATE INT NULL
,DELIVERY_LATENCY INT NULL
,ERROR_ID INT NULL
,JOB_ID BINARY(16) NULL
,LOCAL_JOB INT NULL
,PROFILE_ID INT NULL
,AGENT_ID INT NULL
,LOCAL_TIMESTAMP BINARY(8) NULL
,OFFLOAD_ENABLED BIT NULL
,OFFLOAD_SERVER VARCHAR(50)
,SUBSCRIBER_TYPE INT NULL)
)') 

-- Default latency threshold is 30 sec. 
--It is common to have 1-2 minute Publisher to Subscriber latency in replication. 
-- With default threshold, we are getting frequent latency alerts. 
--Hence changing latency threshold to 120 sec for monitoring solution.

UPDATE #REPLMONITORSUBSCRIPTION SET LATENCYTHRESHOLD = 30

SELECT S.PUBLISHER, S.PUBLISHER_DB, S.PUBLICATION, S.DISTRIBUTION_DB, S.SUBSCRIBER, 
S.SUBSCRIBER_DB, S.LATENCY, 
S.LAST_DISTSYNC,
CASE WHEN (S.LATENCY/S.LATENCYTHRESHOLD)* 100 < 34 THEN 'Excellent' 
WHEN (S.LATENCY/S.LATENCYTHRESHOLD)* 100 < 59 THEN 'Good' 
WHEN (S.LATENCY/S.LATENCYTHRESHOLD)* 100 < 84 
THEN 'Fair' WHEN (S.LATENCY/S.LATENCYTHRESHOLD)* 100 < 99 
THEN 'Poor' ELSE 'Critical' END AS PERFORMANCE,
CASE S.WARNING WHEN 0 THEN 'NA' WHEN 1 THEN 'Expiration' 
WHEN 2 THEN 'Latency' ELSE 'Unknown' END AS WARNING,
CASE L.STATUS WHEN 1 THEN 'Started' WHEN 2 THEN 'Stopped' 
WHEN 3 THEN 'In Progress' WHEN 4 THEN 'Idle' WHEN 5 
THEN 'Retrying' WHEN 6 THEN 'Failed' ELSE 'Unknown' END AS LOGREADERAGENTSTATUS,
CASE D.STATUS WHEN 1 THEN 'Started' WHEN 2 THEN 'Stopped' WHEN 3 THEN 'In Progress' 
WHEN 4 THEN 'Idle' WHEN 5
THEN 'Retrying' WHEN 6 THEN 'Failed' ELSE 'Unknown' END AS DISTRIBUTIONAGENTSTATUS
FROM #REPLMONITORSUBSCRIPTION S 
LEFT OUTER JOIN #REPLLOGREADERAGENT L ON S.LOGREADERAGENTNAME = L.NAME 
AND S.DISTRIBUTION_DB = L.DBNAME
AND S.PUBLISHER = L.PUBLISHER AND S.PUBLISHER_DB = L.PUBLISHER_DB
LEFT OUTER JOIN #REPLDISTRIBUTORAGENT D ON S.DISTRIBUTION_AGENTNAME = D.NAME 
AND S.DISTRIBUTION_DB = L.DBNAME AND S.PUBLISHER = L.PUBLISHER 
AND S.PUBLISHER_DB = L.PUBLISHER_DB 
AND S.PUBLICATION = D.PUBLICATION AND S.SUBSCRIBER = D.SUBSCRIBER 
AND S.SUBSCRIBER_DB = D.SUBSCRIBER_DB


IF OBJECT_ID('tempdb..#ReplicationStatus') IS NOT NULL
    DROP TABLE #ReplicationStatus;

CREATE TABLE #ReplicationStatus (
    Publisher SYSNAME,
    Publisher_DB SYSNAME,
    Publication SYSNAME,
    Distribution_DB SYSNAME,
    Subscriber SYSNAME,
    Subscriber_DB SYSNAME,
    Latency INT,
    Last_DistSync DATETIME,
    Performance VARCHAR(20),
    Warning VARCHAR(20),
    LogReaderAgentStatus VARCHAR(50),
    DistributionAgentStatus VARCHAR(50)
);

-- Step 2: Insert data from the procedure
INSERT INTO #ReplicationStatus
SELECT 
    S.PUBLISHER,
    S.PUBLISHER_DB,
    S.PUBLICATION,
    S.DISTRIBUTION_DB,
    S.SUBSCRIBER,
    S.SUBSCRIBER_DB,
    S.LATENCY,
    S.LAST_DISTSYNC,
    CASE 
        WHEN (S.LATENCY / NULLIF(S.LATENCYTHRESHOLD, 0)) * 100 < 34 THEN 'Excellent'
        WHEN (S.LATENCY / NULLIF(S.LATENCYTHRESHOLD, 0)) * 100 < 59 THEN 'Good'
        WHEN (S.LATENCY / NULLIF(S.LATENCYTHRESHOLD, 0)) * 100 < 84 THEN 'Fair'
        WHEN (S.LATENCY / NULLIF(S.LATENCYTHRESHOLD, 0)) * 100 < 99 THEN 'Poor'
        ELSE 'Critical'
    END AS Performance,
    CASE S.WARNING 
        WHEN 0 THEN 'NA' 
        WHEN 1 THEN 'Expiration' 
        WHEN 2 THEN 'Latency' 
        ELSE 'Unknown' 
    END AS Warning,
    CASE L.STATUS 
        WHEN 1 THEN 'Started' 
        WHEN 2 THEN 'Stopped' 
        WHEN 3 THEN 'In Progress' 
        WHEN 4 THEN 'Idle' 
        WHEN 5 THEN 'Retrying' 
        WHEN 6 THEN 'Failed' 
        ELSE 'Unknown' 
    END AS LogReaderAgentStatus,
    CASE D.STATUS 
        WHEN 1 THEN 'Started' 
        WHEN 2 THEN 'Stopped' 
        WHEN 3 THEN 'In Progress' 
        WHEN 4 THEN 'Idle' 
        WHEN 5 THEN 'Retrying' 
        WHEN 6 THEN 'Failed' 
        ELSE 'Unknown' 
    END AS DistributionAgentStatus
FROM #REPLMONITORSUBSCRIPTION S
LEFT JOIN #REPLLOGREADERAGENT L 
    ON S.LOGREADERAGENTNAME = L.NAME 
    AND S.DISTRIBUTION_DB = L.DBNAME 
    AND S.PUBLISHER = L.PUBLISHER 
    AND S.PUBLISHER_DB = L.PUBLISHER_DB
LEFT JOIN #REPLDISTRIBUTORAGENT D 
    ON S.DISTRIBUTION_AGENTNAME = D.NAME 
    AND S.DISTRIBUTION_DB = D.DBNAME 
    AND S.PUBLISHER = D.PUBLISHER 
    AND S.PUBLISHER_DB = D.PUBLISHER_DB 
    AND S.PUBLICATION = D.PUBLICATION 
    AND S.SUBSCRIBER = D.SUBSCRIBER 
    AND S.SUBSCRIBER_DB = D.SUBSCRIBER_DB;



--DROP TABLE #ReplicationStatus
--DROP TABLE #REPLMONITORPUBLISHER 
--DROP TABLE #REPLMONITORSUBSCRIPTION 
--DROP TABLE #REPLLOGREADERAGENT 
--DROP TABLE #REPLDISTRIBUTORAGENT ;

select  * from  #ReplicationStatus


-- Step 1: Select the first available DB Mail profile
--DECLARE @profile_name NVARCHAR(128);
--SELECT TOP 1 @profile_name = name FROM msdb.dbo.sysmail_profile;

---- Step 2: Get server name
--DECLARE @server_name NVARCHAR(128);
--SELECT @server_name = @@SERVERNAME;

---- Step 3: Define email subject
--DECLARE @subject NVARCHAR(256) = @server_name + ' - Replication Status Report';

---- Step 4: Build HTML table from #ReplicationStatus
--DECLARE @html NVARCHAR(MAX) = N'
--<html>
--<head>
--<style>
--table { border-collapse: collapse; width: 100%; }
--th, td { border: 1px solid black; padding: 8px; text-align: left; }
--th { background-color: #f2f2f2; }
--</style>
--</head>
--<body>
--<h2>Replication Status Report</h2>
--<table>
--<tr>
--<th>Publisher</th>
--<th>Publisher DB</th>
--<th>Publication</th>
--<th>Distribution DB</th>
--<th>Subscriber</th>
--<th>Subscriber DB</th>
--<th>Latency</th>
--<th>Last Sync</th>
--<th>Performance</th>
--<th>Warning</th>
--<th>LogReader Status</th>
--<th>Distributor Status</th>
--</tr>';

--SELECT @html += '
--<tr>
--<td>' + Publisher + '</td>
--<td>' + Publisher_DB + '</td>
--<td>' + Publication + '</td>
--<td>' + Distribution_DB + '</td>
--<td>' + Subscriber + '</td>
--<td>' + Subscriber_DB + '</td>
--<td>' + CAST(Latency AS NVARCHAR) + '</td>
--<td>' + CONVERT(NVARCHAR, Last_DistSync, 120) + '</td>
--<td>' + Performance + '</td>
--<td>' + Warning + '</td>
--<td>' + LogReaderAgentStatus + '</td>
--<td>' + DistributionAgentStatus + '</td>
--</tr>'
--FROM #ReplicationStatus;

--SET @html += '</table></body></html>';

---- Step 5: Send email
--EXEC msdb.dbo.sp_send_dbmail
--    @profile_name = @profile_name,

--	@recipients = 'ag385034@ncratleos.com;ly385002@ncratleos.com;ck385008@ncratleos.com',
--   -- @recipients = 'your_email@domain.com',  -- Replace with actual recipient
--    @subject = @subject,
--    @body = @html,
--    @body_format = 'HTML';


-- Step 1: Select the first available DB Mail profile
DECLARE @profile_name NVARCHAR(128);
SELECT TOP 1 @profile_name = name FROM msdb.dbo.sysmail_profile;

-- Step 2: Get server name
DECLARE @server_name NVARCHAR(128);
SELECT @server_name = @@SERVERNAME;

-- Step 3: Define email subject
DECLARE @subject NVARCHAR(256) = @server_name + ' - Replication Status Report';

-- âœ… Step 4: Check if temp table has data
IF NOT EXISTS (SELECT 1 FROM #ReplicationStatus)
BEGIN
    PRINT 'No replication status data found. Skipping email.';
    RETURN;
END

-- Step 5: Build HTML table from #ReplicationStatus
DECLARE @html NVARCHAR(MAX) = N'
<html>
<head>
<style>
table { border-collapse: collapse; width: 100%; }
th, td { border: 1px solid black; padding: 8px; text-align: left; }
th { background-color: #f2f2f2; }
</style>
</head>
<body>
<h2>Replication Status Report</h2>
<table>
<tr>
<th>Publisher</th>
<th>Publisher DB</th>
<th>Publication</th>
<th>Distribution DB</th>
<th>Subscriber</th>
<th>Subscriber DB</th>
<th>Latency</th>
<th>Last Sync</th>
<th>Performance</th>
<th>Warning</th>
<th>LogReader Status</th>
<th>Distributor Status</th>
</tr>';

SELECT @html += '
<tr>
<td>' + ISNULL(Publisher, '') + '</td>
<td>' + ISNULL(Publisher_DB, '') + '</td>
<td>' + ISNULL(Publication, '') + '</td>
<td>' + ISNULL(Distribution_DB, '') + '</td>
<td>' + ISNULL(Subscriber, '') + '</td>
<td>' + ISNULL(Subscriber_DB, '') + '</td>
<td>' + CAST(ISNULL(Latency, 0) AS NVARCHAR) + '</td>
<td>' + CONVERT(NVARCHAR, Last_DistSync, 120) + '</td>
<td>' + ISNULL(Performance, '') + '</td>
<td>' + ISNULL(Warning, '') + '</td>
<td>' + ISNULL(LogReaderAgentStatus, '') + '</td>
<td>' + ISNULL(DistributionAgentStatus, '') + '</td>
</tr>'
FROM #ReplicationStatus;

SET @html += '</table></body></html>';

-- Step 6: Send email
EXEC msdb.dbo.sp_send_dbmail
    @profile_name = @profile_name,
    @recipients = 'ag385034@ncratleos.com',
    @subject = @subject,
    @body = @html,
    @body_format = 'HTML';
